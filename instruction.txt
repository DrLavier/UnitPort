# Claude Code Prompt: UnitPort Project Structure Migration

你是负责实施本仓库结构迁移的 Claude Code 工程代理。你的任务是按照 `PROJECT_STRUCTURE_NEW.md` 将当前项目从旧结构迁移到新结构。

## 0. 输入与权威文档

必须先读取并以以下文件为唯一权威来源：
1. `PROJECT_STRUCTURE_NEW.md`（目标结构）
2. `PROJECT_README.md`（产品架构定义）
3. `models/unitree/SDK_README.md`（SDK执行路径知识库）

若三者有冲突，优先级：
`PROJECT_README.md` > `PROJECT_STRUCTURE_NEW.md` > 其他文档。

## 1. 迁移目标

将项目按“四设计层 + 三交互层”重组：
- 设计层：`Mission / Behavior / Service / Runtime(含Safety)`
- 交互层：`Canvas / Compiler / Scenario`

并确保：
1. 各层有独立项目空间（目录边界清晰）。
2. `Service` 层具备后续持续接入新 SDK 的扩展能力（adapter registry + adapter ABI）。
3. Runtime 内置 Safety 拦截，在编译与执行阶段都可触发检查。
4. 迁移后系统可继续运行（允许通过 bridge 兼容旧接口）。

## 2. 强制约束

1. 不做一次性“大爆炸”重写，采用渐进式迁移。
2. 先迁目录与接口，再迁逻辑实现。
3. 保留旧行为可运行，必要时建立 `legacy/` bridge。
4. 不在 UI 层直接调用厂商 SDK。
5. 所有 SDK 调用必须收敛到 `design/service/adapters/`。
6. Canvas 与 Compiler 的语义必须收敛到统一 IR（`shared/ir/`）。

## 3. 实施顺序（必须按顺序）

### M1. 结构落位
- 创建新目录骨架（按 `PROJECT_STRUCTURE_NEW.md`）。
- 创建每个层级最小 README 和空模块入口（`__init__.py`/占位文件）。

### M2. 兼容桥接
- 建立 `legacy/bin_core_bridge` 与 `legacy/bin_components_bridge`。
- 让旧调用路径先可转发到新目录的入口模块。

### M3. 运行主链迁移
- 将任务执行主链迁移到 `design/runtime/`。
- 将任务/行为模型分别落到 `design/mission/` 与 `design/behavior/`。

### M4. Service 抽象迁移
- 定义 `base_adapter.py`（connect/init/call/stream/health/stop）。
- 抽离 Unitree 逻辑到 `design/service/adapters/unitree_sdk2/`。
- 建立 `service_registry.py` 与 `service_router.py`。

### M5. 前端分区迁移
- 将 UI 组织为 `frontend/canvas`、`frontend/compiler`、`frontend/scenario`。
- Scenario 与 Runtime 配置对接，支持仿真/真机参数入口。

### M6. 收尾与去重
- 清理重复职责。
- 更新 import 路径。
- 补齐 README 和迁移说明。

## 4. 每阶段交付物

每个里程碑完成后必须输出：
1. 变更清单（新增/移动/删除文件）
2. 接口清单（新增类、函数、模块边界）
3. 风险清单（兼容性、行为变化、回滚点）
4. 验证结果（最少 smoke test）

## 5. 验收标准（DoD）

全部满足才算完成：
1. 目录结构与 `PROJECT_STRUCTURE_NEW.md` 对齐。
2. 四设计层、三交互层目录均有可用入口与文档说明。
3. Runtime 主链能驱动 Mission + Behavior，并通过 Service 路由到 SDK。
4. Service 适配层可新增第二个占位 SDK adapter（证明可扩展）。
5. Safety 拦截在编译期与执行期至少各有一个可触发检查点。
6. 旧入口至少通过 legacy bridge 保持可运行。

## 6. 代码质量要求

1. 小步提交，避免超大补丁。
2. 关键边界加注释，避免“魔法耦合”。
3. 保持 UTF-8 编码，避免乱码扩散。
4. 不引入未使用依赖。
5. 不修改业务语义时，优先做结构搬迁和转发封装。

## 7. 失败处理策略

如果某阶段被阻塞：
1. 先输出阻塞原因。
2. 给出 2-3 个替代方案（含代价）。
3. 选择最低风险方案继续，不停在分析阶段。

## 8. 执行指令

现在开始实施 M1，并在完成后提交 M1 的四项交付物。完成一个里程碑再进入下一个。
